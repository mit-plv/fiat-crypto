name: CI (Coq, Arch Linux)

on:
  push:
    branches: [ master ]
  pull_request:
  merge_group:
  workflow_dispatch:
  release:
    types: [published]
  schedule:
    - cron: '0 0 1 * *'

jobs:
  build:

    runs-on: ubuntu-latest
    container: archlinux
    name: archlinux

    concurrency:
      group: ${{ github.workflow }}-archlinux-${{ github.head_ref || github.run_id }}
      cancel-in-progress: true

    steps:
    - name: Install system dependencies
      run: |
        pacman --noconfirm -Syu base-devel git make python3 which jq ghc ghc-static time diffutils coq ocaml-zarith --needed
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: work around coq issue 15663
      run: |
        ln -s /usr/lib/coq /usr/lib/ocaml/coq
        ln -s /usr/lib/coq-core /usr/lib/ocaml/coq-core
        ln -s /usr/lib/coqide-server /usr/lib/ocaml/coqide-server
    - name: Work around https://github.com/actions/checkout/issues/766
      run: git config --global --add safe.directory "*"
    - name: chroot build params
      run: etc/ci/describe-system-config.sh
    - name: make garagedoor
      run: /usr/bin/time -v make -j src/Bedrock/End2End/X25519/GarageDoorTop.vo
