name: Test opam package

on:
  push:
    branches:
    - master
  schedule:
    - cron: '0 0 1 * *'

jobs:
  install:

    strategy:
      fail-fast: false
      matrix:
        coq-version: ['dev', '8.13.1', '8.12.2', '8.11.1', '8.10.2', '8.9.1']
        os: ['ubuntu-latest', 'macos-latest', 'windows-latest']
        ocaml-version: ['4.11.1']

    runs-on: ${{ matrix.os }}

    env:
      OPAMYES: "true"

    defaults:
      run:
        shell: bash

    steps:
    - name: Set up OCaml
      uses: avsm/setup-ocaml@v1.1.10
      with:
        ocaml-version: ${{ matrix.ocaml-version }}

    - name: echo build params
      run: |
        eval $(opam env)
        echo "::group::lscpu"
        lscpu
        echo "::endgroup::"
        echo "::group::uname -a"
        uname -a
        echo "::endgroup::"
        echo "::group::lsb_release -a"
        lsb_release -a
        echo "::endgroup::"
        echo "::group::gcc -v"
        gcc -v
        echo "::endgroup::"
        echo "::group::ocamlc -config"
        ocamlc -config
        echo "::endgroup::"
        echo "::group::opam list"
        opam list
        echo "::endgroup::"

    - name: Install Coq
      run: |
        set -e
        eval $(opam env)
        opam repo add coq-core-dev https://coq.inria.fr/opam/core-dev
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam repo add coq-extra-dev https://coq.inria.fr/opam/extra-dev
        opam update
        opam install opam-depext
        opam-depext coq
        opam pin add coq ${{ matrix.coq-version }}

    - name: echo more build params
      run: |
        eval $(opam env)
        echo "::group::opam list"
        opam list
        echo "::endgroup::"
        echo "::group::coqc --config"
        coqc --config
        echo "::endgroup::"
        echo "::group::coqc --version"
        coqc --version
        echo "::endgroup::"
        echo "::group::true | coqtop"
        true | coqtop
        echo "::endgroup::"

    - name: Install Fiat-Crypto
      run: |
        set -e
        eval $(opam env)
        opam-depext fiat-crypto
        opam install fiat-crypto
        opam list

    - name: Test Fiat-Crypto binaries
      run: |
        set -e
        eval $(opam env)
        word_by_word_montgomery -h
        unsaturated_solinas -h
        saturated_solinas -h
        base_conversion -h
