name: CI (Coq, Debian)

on:
  push:
    branches: [ master , sp2019latest ]
  pull_request:
  merge_group:
  workflow_dispatch:
  release:
    types: [published]
  schedule:
    - cron: '0 0 1 * *'

jobs:
  build:

    strategy:
      fail-fast: false
      matrix:
        include:
        - env: { DEBIAN: "sid" }
        #- env: { DEBIAN: "bookworm" }# restore once 8.17 lands in Debian stable

    runs-on: 'ubuntu-22.04'
    env: ${{ matrix.env }}
    name: debian-${{ matrix.env.DEBIAN }}

    concurrency:
      group: ${{ github.workflow }}-${{ matrix.env.DEBIAN }}-${{ github.head_ref || github.run_id }}
      cancel-in-progress: true

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: setup Debian chroot
      run: etc/ci/setup-debian-chroot.sh "$DEBIAN"
    - name: host build params
      run: etc/ci/describe-system-config.sh
    - name: chroot build params
      shell: in-debian-chroot.sh {0}
      run: CI=1 etc/ci/describe-system-config.sh
    - name: make garagedoor
      shell: in-debian-chroot.sh {0}
      run: /usr/bin/time -v make -j src/Bedrock/End2End/X25519/GarageDoorTop.vo
