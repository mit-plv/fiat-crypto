sudo: required

dist: trusty

cache:
  directories:
    - $HOME/.cache/vos

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test

before_install:
  - if [ ! -z "$PPA" ]; then sudo add-apt-repository "$PPA" -y; fi
  - travis_retry ./etc/ci/sudo-apt-get-update.sh -q
  - travis_retry sudo apt-get install g++-7 libssl-dev ocaml-findlib $COQ_PACKAGE -y --allow-unauthenticated


before_script:
  - uname -a
  - coqc --version
  - echo | coqtop
  - source ./etc/ci/travis_keep_alive.sh
  - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 60 --slave /usr/bin/g++ g++ /usr/bin/g++-7
  - ./etc/ci/remove_autogenerated.sh

matrix:
  fast_finish: true

jobs:
  include:
    - stage: deps
      env: COQ_VERSION="master" COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-master-daily"
      language: c
      script: CUR=deps ./etc/ci/travis.sh -j2 deps
    - stage: deps
      env: COQ_VERSION="v8.10"  COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.10-daily"
      language: c
      script: CUR=deps ./etc/ci/travis.sh -j2 deps
    - stage: deps
      env: COQ_VERSION="v8.9"   COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.9-daily"
      language: c
      script: CUR=deps ./etc/ci/travis.sh -j2 deps
    - stage: deps
      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
      language: c
      script: CUR=deps ./etc/ci/travis.sh -j2 deps
    - stage: deps
      env: COQ_VERSION="8.9.1"  COQ_PACKAGE="coq-8.9.1 libcoq-8.9.1-ocaml-dev"   PPA="ppa:jgross-h/many-coq-versions"
      language: c
      script: CUR=deps ./etc/ci/travis.sh -j2 deps

    - stage: some-early util printlite lite
      env: COQ_VERSION="master" COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-master-daily"
      language: c
      script: PREV=deps CUR=early ./etc/ci/travis.sh -j2 some-early util printlite lite
    - stage: some-early util printlite lite
      env: COQ_VERSION="v8.10"  COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.10-daily"
      language: c
      script: PREV=deps CUR=early ./etc/ci/travis.sh -j2 some-early util printlite lite
    - stage: some-early util printlite lite
      env: COQ_VERSION="v8.9"   COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.9-daily"
      language: c
      script: PREV=deps CUR=early ./etc/ci/travis.sh -j2 some-early util printlite lite
    - stage: some-early util printlite lite
      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
      language: c
      script: PREV=deps CUR=early ./etc/ci/travis.sh -j2 some-early util printlite lite
    - stage: some-early util printlite lite
      env: COQ_VERSION="8.9.1"  COQ_PACKAGE="coq-8.9.1 libcoq-8.9.1-ocaml-dev"   PPA="ppa:jgross-h/many-coq-versions"
      language: c
      script: PREV=deps CUR=early ./etc/ci/travis.sh -j2 some-early util printlite lite

    - stage: pre-standalone print-nobigmem nobigmem
      env: COQ_VERSION="master" COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-master-daily"
      language: c
      script: PREV=early CUR=pre-standalone ./etc/ci/travis.sh -j2 pre-standalone print-nobigmem nobigmem
    - stage: pre-standalone print-nobigmem nobigmem
      env: COQ_VERSION="v8.10"  COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.10-daily"
      language: c
      script: PREV=early CUR=pre-standalone ./etc/ci/travis.sh -j2 pre-standalone print-nobigmem nobigmem
    - stage: pre-standalone print-nobigmem nobigmem
      env: COQ_VERSION="v8.9"   COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.9-daily"
      language: c
      script: PREV=early CUR=pre-standalone ./etc/ci/travis.sh -j2 pre-standalone print-nobigmem nobigmem
    - stage: pre-standalone print-nobigmem nobigmem
      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
      language: c
      script: PREV=early CUR=pre-standalone ./etc/ci/travis.sh -j2 pre-standalone print-nobigmem nobigmem
    - stage: pre-standalone print-nobigmem nobigmem
      env: COQ_VERSION="8.9.1"  COQ_PACKAGE="coq-8.9.1 libcoq-8.9.1-ocaml-dev"   PPA="ppa:jgross-h/many-coq-versions"
      language: c
      script: PREV=early CUR=pre-standalone ./etc/ci/travis.sh -j2 pre-standalone print-nobigmem nobigmem

    - stage: coq
      env: COQ_VERSION="master" COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-master-daily"
      language: c
      script: PREV=pre-standalone CUR=coq ./etc/ci/travis.sh -j1 coq
    - stage: coq
      env: COQ_VERSION="v8.10"  COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.10-daily"
      language: c
      script: PREV=pre-standalone CUR=coq ./etc/ci/travis.sh -j1 coq
    - stage: coq
      env: COQ_VERSION="v8.9"   COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.9-daily"
      language: c
      script: PREV=pre-standalone CUR=coq ./etc/ci/travis.sh -j1 coq
    - stage: coq
      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
      language: c
      script: PREV=pre-standalone CUR=coq ./etc/ci/travis.sh -j1 coq
    - stage: coq
      env: COQ_VERSION="8.9.1"  COQ_PACKAGE="coq-8.9.1 libcoq-8.9.1-ocaml-dev"   PPA="ppa:jgross-h/many-coq-versions"
      language: c
      script: PREV=pre-standalone CUR=coq ./etc/ci/travis.sh -j1 coq

    - stage: all
      env: COQ_VERSION="master" COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-master-daily"
      language: c
      script: PREV=coq CUR=all ./etc/ci/travis.sh -j2 all
    - stage: all
      env: COQ_VERSION="v8.10"  COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.10-daily"
      language: c
      script: PREV=coq CUR=all ./etc/ci/travis.sh -j2 all
    - stage: all
      env: COQ_VERSION="v8.9"   COQ_PACKAGE="coq libcoq-ocaml-dev"               PPA="ppa:jgross-h/coq-8.9-daily"
      language: c
      script: PREV=coq CUR=all ./etc/ci/travis.sh -j2 all
    - stage: all
      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
      language: c
      script: PREV=coq CUR=all ./etc/ci/travis.sh -j2 all
    - stage: all
      env: COQ_VERSION="8.9.1"  COQ_PACKAGE="coq-8.9.1 libcoq-8.9.1-ocaml-dev"   PPA="ppa:jgross-h/many-coq-versions"
      language: c
      script: PREV=coq CUR=all ./etc/ci/travis.sh -j2 all

    - stage: standalone-ocaml
      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
      language: c
      compiler: gcc
      script: PREV=all CUR=standalone-ocaml ./etc/ci/travis.sh -j2 standalone-ocaml perf-standalone c-files rust-files test-c-files CC=gcc
    - stage: standalone-ocaml
      env: COQ_VERSION="8.9.1"  COQ_PACKAGE="coq-8.9.1 libcoq-8.9.1-ocaml-dev"   PPA="ppa:jgross-h/many-coq-versions"
      language: c
      compiler: gcc
      script: PREV=all CUR=standalone-ocaml ./etc/ci/travis.sh -j2 standalone-ocaml perf-standalone c-files rust-files test-c-files CC=gcc

    - stage: test-rust
      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
      language: rust
      rust: nightly
      script: PREV=standalone-ocaml CUR=test-rust EXTERNAL_DEPENDENCIES=1 TOUCH=rust-files ./etc/ci/travis.sh -j2 test-rust-files

#    - stage: selected-test selected-bench
#      env: COQ_VERSION="8.10.0" COQ_PACKAGE="coq-8.10.0 libcoq-8.10.0-ocaml-dev" PPA="ppa:jgross-h/many-coq-versions-ocaml-4-05"
#      script: PREV=standalone-ocaml CUR=selected-test-bench ./etc/ci/travis.sh -j2 selected-test selected-bench
#    - stage: selected-test selected-bench
#      env: COQ_VERSION="8.9.1"  COQ_PACKAGE="coq-8.9.1 libcoq-8.9.1-ocaml-dev"   PPA="ppa:jgross-h/many-coq-versions"
#      script: PREV=standalone-ocaml CUR=selected-test-bench ./etc/ci/travis.sh -j2 selected-test selected-bench

after_success:
  - kill $PID_KEEP_ALIVE
