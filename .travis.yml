language: c

sudo: required

dist: trusty

compiler:
  - gcc

cache:
  directories:
    - $HOME/.cache/vos

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test

before_install:
  - if [ ! -z "$PPA" ]; then sudo add-apt-repository "$PPA" -y; fi
  - travis_retry ./etc/ci/sudo-apt-get-update.sh -q
  - travis_retry sudo apt-get install g++-7 libssl-dev $COQ_PACKAGE -y --allow-unauthenticated


before_script:
  - uname -a
  - coqc --version
  - echo | coqtop
  - source ./etc/ci/travis_keep_alive.sh
  - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 60 --slave /usr/bin/g++ g++ /usr/bin/g++-7
  - ./etc/ci/remove_autogenerated.sh

matrix:
  fast_finish: true

stages:
  - some-early util
  - printlite lite
  - pre-standalone
  - new-pipeline
  - no-curves-proofs-non-specific
  - curves-proofs
  - selected-specific selected-specific-display
  - selected-test selected-bench

jobs:
  include:
    - stage: some-early util
      env: COQ_VERSION="master" COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-master-daily"
      allow_failure: true
      script: CUR=early ./etc/ci/travis.sh some-early util
    - stage: some-early util
      env: COQ_VERSION="v8.8"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.8-daily"
      allow_failure: true
      script: CUR=early ./etc/ci/travis.sh some-early util
    - stage: some-early util
      env: COQ_VERSION="v8.7"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.7-daily"
      allow_failure: true
      script: CUR=early ./etc/ci/travis.sh some-early util
    - stage: some-early util
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: CUR=early ./etc/ci/travis.sh some-early util
    - stage: some-early util
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: CUR=early ./etc/ci/travis.sh some-early util

    - stage: printlite lite
      env: COQ_VERSION="master" COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-master-daily"
      allow_failure: true
      script: PREV=early CUR=lite ./etc/ci/travis.sh printlite lite
    - stage: printlite lite
      env: COQ_VERSION="v8.8"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.8-daily"
      allow_failure: true
      script: PREV=early CUR=lite ./etc/ci/travis.sh printlite lite
    - stage: printlite lite
      env: COQ_VERSION="v8.7"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.7-daily"
      allow_failure: true
      script: PREV=early CUR=lite ./etc/ci/travis.sh printlite lite
    - stage: printlite lite
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=early CUR=lite ./etc/ci/travis.sh printlite lite
    - stage: printlite lite
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=early CUR=lite ./etc/ci/travis.sh printlite lite

    - stage: pre-standalone
      env: COQ_VERSION="master" COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-master-daily"
      script: PREV=lite CUR=pre-standalone ./etc/ci/travis.sh pre-standalone
    - stage: pre-standalone
      env: COQ_VERSION="v8.8"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.8-daily"
      script: PREV=lite CUR=pre-standalone ./etc/ci/travis.sh pre-standalone
    - stage: pre-standalone
      env: COQ_VERSION="v8.7"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.7-daily"
      script: PREV=lite CUR=pre-standalone ./etc/ci/travis.sh pre-standalone
    - stage: pre-standalone
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=lite CUR=pre-standalone ./etc/ci/travis.sh pre-standalone
    - stage: pre-standalone
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=lite CUR=pre-standalone ./etc/ci/travis.sh pre-standalone

    - stage: new-pipeline
      env: COQ_VERSION="master" COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-master-daily"
      script: PREV=pre-standalone CUR=new-pipeline ./etc/ci/travis.sh new-pipeline
    - stage: new-pipeline
      env: COQ_VERSION="v8.8"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.8-daily"
      script: PREV=pre-standalone CUR=new-pipeline ./etc/ci/travis.sh new-pipeline
    - stage: new-pipeline
      env: COQ_VERSION="v8.7"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.7-daily"
      script: PREV=pre-standalone CUR=new-pipeline ./etc/ci/travis.sh new-pipeline
    - stage: new-pipeline
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=pre-standalone CUR=new-pipeline ./etc/ci/travis.sh new-pipeline
    - stage: new-pipeline
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=pre-standalone CUR=new-pipeline ./etc/ci/travis.sh new-pipeline

    - stage: no-curves-proofs-non-specific
      env: COQ_VERSION="master" COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-master-daily"
      script: PREV=new-pipeline CUR=no-curves-proofs-non-specific ./etc/ci/travis.sh no-curves-proofs-non-specific
    - stage: no-curves-proofs-non-specific
      env: COQ_VERSION="v8.8"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.8-daily"
      script: PREV=new-pipeline CUR=no-curves-proofs-non-specific ./etc/ci/travis.sh no-curves-proofs-non-specific
    - stage: no-curves-proofs-non-specific
      env: COQ_VERSION="v8.7"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.7-daily"
      script: PREV=new-pipeline CUR=no-curves-proofs-non-specific ./etc/ci/travis.sh no-curves-proofs-non-specific
    - stage: no-curves-proofs-non-specific
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=new-pipeline CUR=no-curves-proofs-non-specific ./etc/ci/travis.sh no-curves-proofs-non-specific
    - stage: no-curves-proofs-non-specific
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=new-pipeline CUR=no-curves-proofs-non-specific ./etc/ci/travis.sh no-curves-proofs-non-specific

    - stage: curves-proofs
      env: COQ_VERSION="master" COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-master-daily"
      allow_failure: true
      script: PREV=no-curves-proofs-non-specific CUR=curves-proofs ./etc/ci/travis.sh curves-proofs
    - stage: curves-proofs
      env: COQ_VERSION="v8.8"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.8-daily"
      allow_failure: true
      script: PREV=no-curves-proofs-non-specific CUR=curves-proofs ./etc/ci/travis.sh curves-proofs
    - stage: curves-proofs
      env: COQ_VERSION="v8.7"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.7-daily"
      allow_failure: true
      script: PREV=no-curves-proofs-non-specific CUR=curves-proofs ./etc/ci/travis.sh curves-proofs
    - stage: curves-proofs
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=no-curves-proofs-non-specific CUR=curves-proofs ./etc/ci/travis.sh curves-proofs
    - stage: curves-proofs
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=no-curves-proofs-non-specific CUR=curves-proofs ./etc/ci/travis.sh curves-proofs

    - stage: selected-specific selected-specific-display
      env: COQ_VERSION="master" COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-master-daily"
      allow_failure: true
      script: PREV=curves-proofs CUR=selected-specific ./etc/ci/travis.sh selected-specific selected-specific-display
    - stage: selected-specific selected-specific-display
      env: COQ_VERSION="v8.8"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.8-daily"
      allow_failure: true
      script: PREV=curves-proofs CUR=selected-specific ./etc/ci/travis.sh selected-specific selected-specific-display
    - stage: selected-specific selected-specific-display
      env: COQ_VERSION="v8.7"   COQ_PACKAGE="coq"       PPA="ppa:jgross-h/coq-8.7-daily"
      allow_failure: true
      script: PREV=curves-proofs CUR=selected-specific ./etc/ci/travis.sh selected-specific selected-specific-display
    - stage: selected-specific selected-specific-display
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=curves-proofs CUR=selected-specific ./etc/ci/travis.sh selected-specific selected-specific-display
    - stage: selected-specific selected-specific-display
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=curves-proofs CUR=selected-specific ./etc/ci/travis.sh selected-specific selected-specific-display

    - stage: build-selected-test build-selected-bench
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=selected-specific CUR=build-selected ./etc/ci/travis.sh build-selected-test build-selected-bench
    - stage: build-selected-test build-selected-bench
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=selected-specific CUR=build-selected ./etc/ci/travis.sh build-selected-test build-selected-bench

    - stage: standalone-ocaml
      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=build-selected CUR=standalone-ocaml ./etc/ci/travis.sh standalone-ocaml c-files test-c-files CC=gcc
    - stage: standalone-ocaml
      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
      script: PREV=build-selected CUR=standalone-ocaml ./etc/ci/travis.sh standalone-ocaml c-files test-c-files CC=gcc

#    - stage: selected-test selected-bench
#      env: COQ_VERSION="8.8.0"  COQ_PACKAGE="coq-8.8.0" PPA="ppa:jgross-h/many-coq-versions"
#      allow_failure: true
#      script: PREV=standalone-ocaml CUR=selected-test-bench ./etc/ci/travis.sh selected-test selected-bench
#    - stage: selected-test selected-bench
#      env: COQ_VERSION="8.7.2"  COQ_PACKAGE="coq-8.7.2" PPA="ppa:jgross-h/many-coq-versions"
#      allow_failure: true
#      script: PREV=standalone-ocaml CUR=selected-test-bench ./etc/ci/travis.sh selected-test selected-bench

after_success:
  - kill $PID_KEEP_ALIVE
